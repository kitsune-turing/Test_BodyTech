version: '3.8'

services:
  # --- Base de Datos ---
  postgres_auth:
    image: postgres:15-alpine
    container_name: postgres_auth
    environment:
      POSTGRES_DB: auth_db
      POSTGRES_USER: auth_user
      POSTGRES_PASSWORD: auth_pass
    volumes:
      - postgres_auth_data:/var/lib/postgresql/data
      - ./services/auth-service/migrations:/docker-entrypoint-initdb.d
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U auth_user -d auth_db"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - microservices-network

  postgres_task:
    image: postgres:15-alpine
    container_name: postgres_task
    environment:
      POSTGRES_DB: task_db
      POSTGRES_USER: task_user
      POSTGRES_PASSWORD: task_pass
    volumes:
      - postgres_task_data:/var/lib/postgresql/data
      - ./services/task-service/migrations:/docker-entrypoint-initdb.d
    ports:
      - "5433:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U task_user -d task_db"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - microservices-network

  # --- Redis ---
  redis:
    image: redis:7-alpine
    container_name: redis
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - microservices-network

  # --- Auth Service ---
  auth-service:
    build:
      context: ./services/auth-service
      dockerfile: Dockerfile
    container_name: auth-service
    environment:
      APP_ENV: development
      DB_HOST: postgres_auth
      DB_PORT: 5432
      DB_NAME: auth_db
      DB_USER: auth_user
      DB_PASS: auth_pass
      REDIS_HOST: redis
      REDIS_PORT: 6379
      JWT_SECRET: your-secret-key-change-in-production-min-32-chars
      JWT_EXP: 3600
      ARGON2_MEMORY_COST: 65536
      ARGON2_TIME_COST: 4
      ARGON2_THREADS: 2
      RATE_LIMIT_ENABLED: "true"
      RATE_LIMIT_DEFAULT: 100
      RATE_LIMIT_WINDOW: 60
    depends_on:
      postgres_auth:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports:
      - "8001:80"
    networks:
      - microservices-network
    command: php -S 0.0.0.0:80 -t /var/www/html/public

  # --- Task Service ---
  task-service:
    build:
      context: ./services/task-service
      dockerfile: Dockerfile
    container_name: task-service
    environment:
      APP_ENV: development
      DB_HOST: postgres_task
      DB_PORT: 5432
      DB_NAME: task_db
      DB_USER: task_user
      DB_PASS: task_pass
      REDIS_HOST: redis
      REDIS_PORT: 6379
      JWT_SECRET: your-secret-key-change-in-production-min-32-chars
      RATE_LIMIT_ENABLED: "true"
      RATE_LIMIT_DEFAULT: 100
      RATE_LIMIT_WINDOW: 60
    depends_on:
      postgres_task:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports:
      - "8002:80"
    networks:
      - microservices-network
    command: php -S 0.0.0.0:80 -t /var/www/html/public

  # --- Realtime Service ---
  realtime-service:
    build:
      context: ./services/realtime-service
      dockerfile: Dockerfile
    container_name: realtime-service
    environment:
      APP_ENV: development
      REDIS_HOST: redis
      REDIS_PORT: 6379
      JWT_SECRET: your-secret-key-change-in-production-min-32-chars
      WS_HOST: 0.0.0.0
      WS_PORT: 9501
    depends_on:
      redis:
        condition: service_healthy
    ports:
      - "9501:9501"
    volumes:
      - ./services/realtime-service:/var/www/html
    networks:
      - microservices-network
    command: php /var/www/html/server.php

  # --- Frontend ---
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        VITE_API_AUTH_URL: http://auth-service/v1/api
        VITE_API_TASK_URL: http://task-service/v1/api
        VITE_WS_URL: ws://realtime-service:9501
    container_name: frontend
    ports:
      - "3000:80"
    depends_on:
      - auth-service
      - task-service
      - realtime-service
    networks:
      - microservices-network
    
volumes:
  postgres_auth_data:
  postgres_task_data:
  redis_data:

networks:
  microservices-network:
    driver: bridge
